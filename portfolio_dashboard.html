<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeGiro Portfolio Analytics - Investment Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #64b5f6;
            --primary-pink: #e91e63;
            --primary-orange: #ff9800;
            --dark-bg: #1a1d29;
            --card-bg: rgba(37, 42, 58, 0.8);
            --card-border: rgba(100, 181, 246, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --text-muted: #a0aec0;
            --green-accent: #10b981;
            --red-accent: #ef4444;
            --yellow-accent: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-pink));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-text h1 {
            font-size: 1.8rem;
            font-weight: 300;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-pink) 50%, var(--primary-orange) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: -1px;
        }

        .brand-text p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }

        .date-info {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-6 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        .grid-7 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .grid-8 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(100, 181, 246, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Metric Cards */
        .metric-card {
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-pink), var(--primary-orange));
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .positive { 
            background: rgba(16, 185, 129, 0.1); 
            color: var(--green-accent); 
        }
        
        .negative { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--red-accent); 
        }

        /* Chart Cards */
        .chart-card {
            position: relative;
        }

        .chart-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .chart-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-container.large {
            height: 400px;
        }

        /* Section Titles */
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 2rem 0 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title i {
            color: var(--primary-blue);
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--card-border);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .grid-2, .grid-3, .grid-4, .grid-6, .grid-7, .grid-8 {
                grid-template-columns: 1fr;
            }
            
            .metric-value {
                font-size: 2rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Custom colors for different chart types */
        .investment-gradient { background: linear-gradient(135deg, var(--primary-blue), var(--primary-pink)); }
        .dividend-gradient { background: linear-gradient(135deg, var(--green-accent), #22c55e); }
        .returns-gradient { background: linear-gradient(135deg, var(--primary-orange), #fbbf24); }
        .portfolio-gradient { background: linear-gradient(135deg, var(--primary-pink), #f97316); }

        /* Product Analysis Styles */
        #productSelect:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.2);
        }

        #productSelect option {
            background: var(--dark-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        #dividendTable tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background-color 0.3s ease;
        }

        /* Time Range Button Styles */
        .time-range-btn {
            background: rgba(100, 181, 246, 0.1);
            border: 1px solid rgba(100, 181, 246, 0.3);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .time-range-btn:hover {
            background: rgba(100, 181, 246, 0.2);
            border-color: rgba(100, 181, 246, 0.5);
            transform: translateY(-1px);
        }

        .time-range-btn.active {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
            box-shadow: 0 2px 8px rgba(100, 181, 246, 0.3);
        }

        #timeRangeButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        #dividendTable tbody tr:hover {
            background: rgba(100, 181, 246, 0.05);
        }

        #dividendTable tbody tr:last-child {
            border-bottom: none;
        }

        #dividendTable td {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
        }

        .dividend-amount {
            font-weight: 600;
            color: var(--green-accent);
        }

        .dividend-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-verified {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green-accent);
        }

        .status-no-withholding {
            background: rgba(100, 181, 246, 0.1);
            color: var(--primary-blue);
        }

        .status-multiple-payments {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-complex {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .transaction-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="brand-text">
                        <h1>DeGiro Portfolio Analytics</h1>
                        <p>Investment Performance Dashboard</p>
                    </div>
                </div>
                <div class="date-info">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="last-updated">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Key Performance Indicators -->
        <h2 class="section-title">
            <i class="fas fa-tachometer-alt"></i>
            Portfolio Overview
        </h2>
        
        <div class="grid grid-8" id="kpi-grid">
            <div class="card metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-university"></i>
                </div>
                <div class="metric-value" id="total-deposits">€0</div>
                <div class="metric-label">Total Deposits</div>
                <div class="metric-change" id="deposit-utilization">0% utilized</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon investment-gradient">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-value" id="total-invested">€0</div>
                <div class="metric-label">Total Invested</div>
                <div class="metric-change" id="invested-change">—</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon returns-gradient">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="metric-value" id="total-return">0%</div>
                <div class="metric-label">Total Return</div>
                <div class="metric-change" id="return-amount">€0</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon dividend-gradient">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="metric-value" id="total-dividends">€0</div>
                <div class="metric-label">Total Net Dividends</div>
                <div class="metric-change" id="dividend-yield">0% yield</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="metric-value" id="current-cash">€0</div>
                <div class="metric-label">Current Cash</div>
                <div class="metric-change" id="cash-percentage">0% of deposits</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon portfolio-gradient">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="metric-value" id="current-value">€0</div>
                <div class="metric-label">Current Portfolio Value</div>
                <div class="metric-change" id="unrealized-gain">€0 unrealized</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="metric-value" id="total-fees">€0</div>
                <div class="metric-label">Total Fees</div>
                <div class="metric-change" id="fee-percentage">0% of portfolio</div>
            </div>

            <div class="card metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                    <i class="fas fa-th-list"></i>
                </div>
                <div class="metric-value" id="total-stocks">0</div>
                <div class="metric-label">Total Stocks</div>
                <div class="metric-change" id="stocks-info">0 with current prices</div>
            </div>
        </div>

        <!-- Performance Analytics -->
        <h2 class="section-title">
            <i class="fas fa-chart-area"></i>
            Performance Analytics
        </h2>
        
        <div class="grid grid-2">
            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Investment Activity Over Time</h3>
                        <p class="chart-subtitle">Quarterly deposits and investment amounts</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="investmentTrendChart"></canvas>
                </div>
            </div>

            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Portfolio Composition</h3>
                        <p class="chart-subtitle">Current holdings by market value</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="portfolioCompositionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-3">

            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Net Dividend Growth</h3>
                        <p class="chart-subtitle">Net dividend income by year</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="dividendGrowthChart"></canvas>
                </div>
            </div>

        </div>

        <!-- Monthly Dividend Analysis -->
        <div class="grid grid-1" style="grid-template-columns: 1fr;">
            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Monthly Dividend Distribution</h3>
                        <p class="chart-subtitle">Stacked view of dividend amounts by month</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyDividendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Product Analysis -->
        <h2 class="section-title">
            <i class="fas fa-search"></i>
            Product Analysis
        </h2>
        
        <div class="grid grid-1" style="grid-template-columns: 1fr;">
            <div class="card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Dividend History by Product</h3>
                        <p class="chart-subtitle">Select a product to view its dividend payments by year-month</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label for="productSelect" style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">
                                Select Product:
                            </label>
                            <select id="productSelect" style="
                                width: 100%; 
                                padding: 0.75rem; 
                                background: var(--dark-bg); 
                                border: 1px solid var(--card-border); 
                                border-radius: 8px; 
                                color: var(--text-primary); 
                                font-size: 1rem;
                                cursor: pointer;
                            ">
                                <option value="">-- All Products --</option>
                            </select>
                        </div>
                        <div>
                            <label for="yearSelect" style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">
                                Select Year:
                            </label>
                            <select id="yearSelect" style="
                                width: 100%; 
                                padding: 0.75rem; 
                                background: var(--dark-bg); 
                                border: 1px solid var(--card-border); 
                                border-radius: 8px; 
                                color: var(--text-primary); 
                                font-size: 1rem;
                                cursor: pointer;
                            ">
                                <option value="">-- All Years --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="dividendTableContainer" style="display: none;">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.1rem;">
                        Net Dividend History for <span id="selectedProductName" style="color: var(--primary-blue);"></span>
                    </h4>
                    <div style="overflow-x: auto;">
                        <table id="dividendTable" style="
                            width: 100%; 
                            border-collapse: collapse; 
                            background: var(--card-bg);
                            border-radius: 8px;
                            overflow: hidden;
                        ">
                            <thead>
                                <tr style="background: rgba(100, 181, 246, 0.1);">
                                    <th style="padding: 1rem; text-align: left; color: var(--text-primary); font-weight: 600; border-bottom: 1px solid var(--card-border);">Year-Month</th>
                                    <th style="padding: 1rem; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 1px solid var(--card-border);">Net Dividend Amount (EUR)</th>
                                    <th style="padding: 1rem; text-align: center; color: var(--text-primary); font-weight: 600; border-bottom: 1px solid var(--card-border);">Status</th>
                                    <th style="padding: 1rem; text-align: center; color: var(--text-primary); font-weight: 600; border-bottom: 1px solid var(--card-border);">Transactions</th>
                                </tr>
                            </thead>
                            <tbody id="dividendTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="dividendSummary" style="
                        margin-top: 1.5rem; 
                        padding: 1rem; 
                        background: rgba(100, 181, 246, 0.05); 
                        border-radius: 8px; 
                        border-left: 4px solid var(--primary-blue);
                    ">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Net Dividends</div>
                                <div id="totalDividends" style="color: var(--primary-blue); font-size: 1.25rem; font-weight: 600;">€0.00</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Transactions</div>
                                <div id="totalTransactions" style="color: var(--text-primary); font-size: 1.25rem; font-weight: 600;">0</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">Active Months</div>
                                <div id="activeMonths" style="color: var(--text-primary); font-size: 1.25rem; font-weight: 600;">0</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">Average per Month</div>
                                <div id="averagePerMonth" style="color: var(--green-accent); font-size: 1.25rem; font-weight: 600;">€0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics -->
        <h2 class="section-title">
            <i class="fas fa-analytics"></i>
            Detailed Analytics
        </h2>
        
        <div class="grid grid-2">
            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Top Net Dividend Stocks</h3>
                        <p class="chart-subtitle">Highest net dividend contributors</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="topDividendStocksChart"></canvas>
                </div>
            </div>

        </div>

        <div class="grid grid-1" style="grid-template-columns: 1fr;">
            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Cumulative Portfolio Performance</h3>
                        <p class="chart-subtitle">Total portfolio value evolution over time</p>
                    </div>
                </div>
                <div class="chart-container large">
                    <canvas id="cumulativePerformanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Stock Analysis Section -->
        <h2 class="section-title">
            <i class="fas fa-chart-line"></i>
            Individual Stock Analysis
            <span style="font-size: 0.875rem; color: var(--text-secondary); margin-left: 1rem;">
                ⚡ Powered by cached data
            </span>
        </h2>
        
        <div class="grid grid-1" style="grid-template-columns: 1fr;">
            <div class="card chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Stock Price History & Transactions</h3>
                        <p class="chart-subtitle">Historical price data since 2015 with your buy/sell operations (cached data)</p>
                    </div>
                    <div class="chart-controls" style="display: flex; flex-direction: column; gap: 1rem; align-items: flex-end;">
                        <select id="stockSelector" style="
                            background: var(--card-bg);
                            border: 1px solid var(--card-border);
                            color: var(--text-primary);
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            font-size: 0.875rem;
                            min-width: 250px;
                        ">
                            <option value="">Select a stock...</option>
                        </select>
                        
                        <div id="timeRangeButtons" style="display: none; gap: 0.5rem;">
                            <button class="time-range-btn active" data-range="YTD">YTD</button>
                            <button class="time-range-btn" data-range="6M">6M</button>
                            <button class="time-range-btn" data-range="1Y">1Y</button>
                            <button class="time-range-btn" data-range="3Y">3Y</button>
                            <button class="time-range-btn" data-range="5Y">5Y</button>
                            <button class="time-range-btn" data-range="ALL">ALL</button>
                        </div>
                    </div>
                </div>
                <div class="chart-container large">
                    <canvas id="stockAnalysisChart"></canvas>
                    <div id="stockAnalysisLoading" style="
                        display: none;
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: var(--text-secondary);
                        font-size: 1.1rem;
                    ">
                        <i class="fas fa-spinner fa-spin"></i> Loading cached data...
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Global variables for data
        let portfolioData = null;
        let masterData = null;  // Add global masterData variable
        let dividendsData = null;
        let buysData = null;
        let sellsData = null;

        // Chart.js default configuration
        Chart.defaults.color = '#8892b0';
        Chart.defaults.font.family = 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(37, 42, 58, 0.95)';
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(100, 181, 246, 0.3)';
        Chart.defaults.plugins.tooltip.borderWidth = 1;

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatPercent(value) {
            return (value > 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',');
            
            return lines.slice(1).map(line => {
                // Handle commas within quoted fields
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const obj = {};
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    value = value.replace(/^"(.*)"$/, '$1'); // Remove quotes
                    
                    // Parse dates - handle both old and new formats
                    if ((header === 'Date' || header === 'date') && value) {
                        obj.Date = new Date(value); // Normalize to Date for compatibility
                        obj.date = value; // Keep original
                    }
                    // Parse numbers
                    else if (['Amount', 'Amount_EUR', 'amount_EUR', 'Balance_EUR', 'Shares_Count', 'Price_Per_Share', 'shares'].includes(header)) {
                        const numValue = value && value !== '' ? parseFloat(value) : 0;
                        obj[header] = numValue;
                        // Normalize column names for compatibility
                        if (header === 'amount_EUR') obj['Amount_EUR'] = numValue;
                        if (header === 'shares') obj['Shares_Count'] = numValue;
                    }
                    // Parse booleans
                    else if (['Is_Valid_Buy', 'Is_Valid_Sell', 'is_valid'].includes(header)) {
                        const boolValue = value === 'True';
                        obj[header] = boolValue;
                        // Normalize for compatibility
                        if (header === 'is_valid') obj['Is_Valid_Buy'] = boolValue;
                    }
                    else {
                        obj[header] = value;
                        // Normalize field names for compatibility
                        if (header === 'product') obj['Company'] = value;
                        if (header === 'year_month') obj['Year_Month'] = value;
                        if (header === 'status') obj['Status'] = value;
                        if (header === 'description') obj['Description'] = value;
                    }
                });
                return obj;
            }).filter(obj => obj.Date && !isNaN(obj.Date.getTime())); // Filter out invalid dates
        }

        // Load data files
        async function loadData() {
            try {
                document.getElementById('last-updated').textContent = 'Loading data...';
                
                // Load data from the new generate_datasets.py script
                console.log('Loading portfolio analysis...');
                let reportResponse;
                try {
                    reportResponse = await fetch(`./output/portfolio_summary.json?t=${Date.now()}`);
                    if (reportResponse.ok) {
                        portfolioData = await reportResponse.json();
                        masterData = portfolioData;  // Set global masterData to full data structure
                        console.log('Portfolio summary data loaded:', portfolioData);
                        console.log('Master data structure:', masterData);
                        console.log('Detailed summaries:', portfolioData.detailed_summaries);
                    } else {
                        throw new Error('Portfolio summary not available - run generate_datasets.py first');
                    }
                } catch (error) {
                    console.log('Portfolio summary not available, trying fallback:', error.message);
                    try {
                        reportResponse = await fetch('./output/master_portfolio_data.json');
                        if (reportResponse.ok) {
                            portfolioData = await reportResponse.json();
                            masterData = portfolioData;
                            console.log('Fallback to master data loaded:', portfolioData);
                        } else {
                            throw new Error('No valid portfolio data found');
                        }
                    } catch (fallbackError) {
                        console.log('Master data not available, trying enhanced analysis:', fallbackError.message);
                        reportResponse = await fetch('./output/enhanced_portfolio_analysis.json');
                        if (!reportResponse.ok) {
                            throw new Error(`Failed to load any analysis report. Please run generate_datasets.py first.`);
                        }
                        portfolioData = await reportResponse.json();
                        masterData = portfolioData.portfolio_overview || portfolioData;
                        console.log('Enhanced portfolio data loaded as last fallback:', portfolioData);
                    }
                }

                // Load CSV files
                console.log('Loading CSV files...');
                const [dividendsResponse, buysResponse, sellsResponse] = await Promise.all([
                    fetch('./output/degiro_dividends.csv').then(r => {
                        if (!r.ok) throw new Error(`Failed to load dividends: ${r.status}`);
                        return r;
                    }),
                    fetch('./output/degiro_buys.csv').then(r => {
                        if (!r.ok) throw new Error(`Failed to load buys: ${r.status}`);
                        return r;
                    }),
                    fetch('./output/degiro_sells.csv').then(r => {
                        if (!r.ok) throw new Error(`Failed to load sells: ${r.status}`);
                        return r;
                    })
                ]);

                dividendsData = parseCSV(await dividendsResponse.text());
                buysData = parseCSV(await buysResponse.text());
                sellsData = parseCSV(await sellsResponse.text());

                console.log('Data loaded successfully:', {
                    dividends: dividendsData.length,
                    buys: buysData.length,
                    sells: sellsData.length
                });

                // Initialize dashboard
                initializeDashboard();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('last-updated').innerHTML = `
                    <span style="color: var(--red-accent)">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading data: ${error.message}
                    </span>
                `;
                
                // Show helpful message
                const container = document.querySelector('main.container');
                container.innerHTML = `
                    <div class="card" style="text-align: center; margin: 2rem 0;">
                        <div style="color: var(--red-accent); font-size: 3rem; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2>Unable to Load Portfolio Data</h2>
                        <p style="color: var(--text-secondary); margin: 1rem 0;">
                            The dashboard couldn't load the required data files. This usually happens due to CORS restrictions when opening HTML files directly in the browser.
                        </p>
                        <div style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                            <h3 style="color: var(--primary-blue); margin-bottom: 0.5rem;">
                                <i class="fas fa-lightbulb"></i> Quick Fix
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Run the dashboard server instead:
                            </p>
                            <code style="background: var(--dark-bg); color: var(--green-accent); padding: 0.5rem 1rem; border-radius: 4px; display: inline-block;">
                                python serve_dashboard.py
                            </code>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button onclick="location.reload()" style="background: var(--primary-blue); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function initializeDashboard() {
            // Update last updated date
            const dateString = portfolioData.metadata?.calculation_timestamp || portfolioData.analysis_date || new Date().toISOString();
            const analysisDate = new Date(dateString);
            document.getElementById('last-updated').textContent = 
                `Last updated: ${analysisDate.toLocaleDateString()} ${analysisDate.toLocaleTimeString()}`;

            // Update KPIs
            updateKPIs();
            
            // Create charts
            createCharts();
        }

        function updateKPIs() {
            // Use global masterData (already set when data loads)
            const overview = {
                // Map new generate_datasets.py structure to expected structure for compatibility
                total_deposits_eur: masterData.portfolio_summary?.total_deposits || masterData.portfolio_overview?.total_deposits_eur || 0,
                current_cash_balance_eur: 0, // Not available in new structure
                current_stock_value_eur: 0, // Not available in new structure  
                true_portfolio_value_eur: masterData.portfolio_summary?.net_invested || masterData.portfolio_overview?.true_portfolio_value_eur || 0,
                total_dividends_received_eur: masterData.portfolio_summary?.total_dividends_received || masterData.portfolio_overview?.total_dividends_received_eur || 0,
                estimated_fees_eur: masterData.portfolio_summary?.total_fees || masterData.portfolio_overview?.estimated_fees_eur || 0,
                true_total_return_eur: masterData.portfolio_summary?.portfolio_return || masterData.portfolio_overview?.true_total_return_eur || 0,
                true_return_percentage: masterData.portfolio_summary?.portfolio_return ? 
                    ((masterData.portfolio_summary.portfolio_return / masterData.portfolio_summary.total_invested) * 100) : 
                    (masterData.portfolio_overview?.true_return_percentage || 0)
            };
            const hasEnhancedData = overview.true_portfolio_value_eur !== undefined;
            
            // Use total dividends from portfolio analysis (all transactions method)
            const totalDividends = overview.total_dividends_received_eur || 0;
            
            // Total Deposits
            document.getElementById('total-deposits').textContent = formatCurrency(overview.total_deposits_eur);
            const depositUtilization = overview.deposit_utilization_percentage || 0;
            document.getElementById('deposit-utilization').textContent = `${depositUtilization.toFixed(1)}% utilized`;
            
            // Total Invested
            document.getElementById('total-invested').textContent = formatCurrency(overview.total_invested_eur);
            
            // Total Return - use enhanced data if available
            let returnPercent, returnAmount, currentPortfolioValue;
            if (hasEnhancedData) {
                returnPercent = overview.true_return_percentage;
                returnAmount = overview.true_total_return_eur;
                currentPortfolioValue = overview.true_portfolio_value_eur;
                console.log('Using enhanced portfolio metrics:', { returnPercent, returnAmount, currentPortfolioValue });
            } else {
                returnPercent = overview.return_percentage;
                returnAmount = overview.total_return_eur;
                currentPortfolioValue = overview.net_current_investment_eur;
                console.log('Using standard portfolio metrics:', { returnPercent, returnAmount, currentPortfolioValue });
            }
            
            document.getElementById('total-return').textContent = formatPercent(returnPercent);
            document.getElementById('return-amount').textContent = formatCurrency(returnAmount);
            document.getElementById('return-amount').className = 
                `metric-change ${returnPercent >= 0 ? 'positive' : 'negative'}`;
            
            // Total Dividends (using computed total from analysis)
            document.getElementById('total-dividends').textContent = formatCurrency(totalDividends);
            const dividendYield = (totalDividends / overview.total_invested_eur * 100);
            document.getElementById('dividend-yield').textContent = `${dividendYield.toFixed(2)}% yield`;
            
            // Current Cash Balance
            const currentCash = masterData.portfolio_summary?.current_cash_eur || 0;
            document.getElementById('current-cash').textContent = formatCurrency(currentCash);
            const cashPercentage = (currentCash / overview.total_deposits_eur * 100);
            document.getElementById('cash-percentage').textContent = `${cashPercentage.toFixed(1)}% of deposits`;
            
            // Current Portfolio Value - use new portfolio data if available
            const totalPortfolioValue = masterData.portfolio_summary?.total_portfolio_value_eur;
            const currentStockValue = masterData.portfolio_summary?.current_portfolio_value_eur;
            
            if (totalPortfolioValue && currentStockValue !== undefined) {
                // Use new portfolio value calculation
                document.getElementById('current-value').textContent = formatCurrency(totalPortfolioValue);
                document.getElementById('unrealized-gain').textContent = `€${currentStockValue.toLocaleString()} stocks + €${currentCash.toLocaleString()} cash`;
            } else {
                // Fallback to old logic
                document.getElementById('current-value').textContent = formatCurrency(currentPortfolioValue);
                if (hasEnhancedData) {
                    const stockValue = overview.current_stock_value_eur || 0;
                    document.getElementById('unrealized-gain').textContent = `€${stockValue.toLocaleString()} in stocks + €${currentCash.toLocaleString()} cash`;
                } else {
                    document.getElementById('unrealized-gain').textContent = `${formatCurrency(returnAmount)} total return`;
                }
            }
            
            // Total Fees
            const totalFees = overview.estimated_fees_eur || 653.17; // Use estimated fees
            document.getElementById('total-fees').textContent = formatCurrency(totalFees);
            const feePercentage = (totalFees / currentPortfolioValue * 100);
            document.getElementById('fee-percentage').textContent = `${feePercentage.toFixed(2)}% of portfolio`;
            
            // Load stock count from current stock values
            loadStockCount();
            
            // Add enhanced data indicator if available
            if (hasEnhancedData) {
                const lastUpdated = document.getElementById('last-updated');
                if (!lastUpdated.textContent.includes('Enhanced')) {
                    lastUpdated.textContent += ' (Enhanced with Live Prices)';
                    lastUpdated.style.color = 'var(--green-accent)';
                }
            }
        }

        function createCharts() {
            console.log('Creating charts with data:', { portfolioData, masterData });
            
            try { createInvestmentTrendChart(); } catch (e) { console.error('Error in createInvestmentTrendChart:', e); }
            try { createPortfolioCompositionChart(); } catch (e) { console.error('Error in createPortfolioCompositionChart:', e); }
            try { createDividendGrowthChart(); } catch (e) { console.error('Error in createDividendGrowthChart:', e); }
            try { createMonthlyDividendChart(); } catch (e) { console.error('Error in createMonthlyDividendChart:', e); }
            try { createTopDividendStocksChart(); } catch (e) { console.error('Error in createTopDividendStocksChart:', e); }
            try { createCumulativePerformanceChart(); } catch (e) { console.error('Error in createCumulativePerformanceChart:', e); }
            
            console.log('Chart creation completed');
            
            // Initialize product analysis
            initializeProductAnalysis();
            
            // Initialize stock analysis
            initializeStockAnalysis();
            
        }

        function createInvestmentTrendChart() {
            const ctx = document.getElementById('investmentTrendChart').getContext('2d');
            
            // Get monthly data from the new architecture
            const monthlyInvestments = masterData?.detailed_summaries?.investments?.investment_by_month || {};
            const monthlyDeposits = masterData?.detailed_summaries?.deposits?.deposit_by_month || {};
            
            // Function to convert month to quarter
            function getQuarter(yearMonth) {
                const [year, month] = yearMonth.split('-');
                const monthNum = parseInt(month);
                const quarter = Math.ceil(monthNum / 3);
                return `${year}-Q${quarter}`;
            }
            
            // Aggregate monthly data into quarters
            const quarterlyInvestments = {};
            const quarterlyDeposits = {};
            
            // Aggregate investments by quarter
            Object.entries(monthlyInvestments).forEach(([month, amount]) => {
                const quarter = getQuarter(month);
                quarterlyInvestments[quarter] = (quarterlyInvestments[quarter] || 0) + amount;
            });
            
            // Aggregate deposits by quarter
            Object.entries(monthlyDeposits).forEach(([month, amount]) => {
                const quarter = getQuarter(month);
                quarterlyDeposits[quarter] = (quarterlyDeposits[quarter] || 0) + amount;
            });
            
            // Get all unique quarters from both datasets
            const allQuarters = new Set([...Object.keys(quarterlyInvestments), ...Object.keys(quarterlyDeposits)]);
            const sortedQuarters = Array.from(allQuarters).sort();
            
            // Create labels for the chart
            const labels = sortedQuarters.map(quarter => quarter);
            
            // Get amounts for each quarter
            const investmentAmounts = sortedQuarters.map(quarter => quarterlyInvestments[quarter] || 0);
            const depositAmounts = sortedQuarters.map(quarter => quarterlyDeposits[quarter] || 0);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quarterly Deposits',
                        data: depositAmounts,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }, {
                        label: 'Quarterly Investments',
                        data: investmentAmounts,
                        borderColor: '#64b5f6',
                        backgroundColor: 'rgba(100, 181, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#64b5f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                color: '#8892b0'
                            }
                        }
                    }
                }
            });
        }

        function createPortfolioCompositionChart() {
            const ctx = document.getElementById('portfolioCompositionChart').getContext('2d');
            
            // Load current stock values from CSV and create portfolio composition
            fetch('./output/current_stock_values.csv?t=' + Date.now())
                .then(response => response.text())
                .then(csvText => {
                    // Parse CSV data
                    const lines = csvText.trim().split('\n');
                    const headers = lines[0].split(',');
                    const stockData = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        const stock = {};
                        headers.forEach((header, index) => {
                            stock[header] = values[index];
                        });
                        
                        // Only include stocks with valid position values (successful price fetches)
                        if (stock.source !== 'failed' && stock.position_value && parseFloat(stock.position_value) > 0) {
                            stock.position_value_num = parseFloat(stock.position_value);
                            stockData.push(stock);
                        }
                    }
                    
                    // Sort by position value (largest to smallest) and take top 10
                    const sortedStocks = stockData
                        .sort((a, b) => b.position_value_num - a.position_value_num)
                        .slice(0, 10);
                    
                    // Get USD to EUR conversion rate from portfolio summary
                    const usdToEurRate = masterData?.portfolio_summary?.current_portfolio_value_eur && 
                                       masterData?.portfolio_summary?.current_portfolio_value_eur > 0 ?
                                       masterData.portfolio_summary.current_portfolio_value_eur / 
                                       stockData.reduce((sum, stock) => sum + stock.position_value_num, 0) : 0.85; // fallback rate
                    
                    // Convert values to EUR and calculate totals
                    const stockDataEUR = stockData.map(stock => ({
                        ...stock,
                        position_value_eur: stock.position_value_num * usdToEurRate
                    }));
                    
                    const sortedStocksEUR = stockDataEUR
                        .sort((a, b) => b.position_value_eur - a.position_value_eur)
                        .slice(0, 10);
                    
                    const totalValueEUR = stockDataEUR.reduce((sum, stock) => sum + stock.position_value_eur, 0);
                    
                    // Prepare chart data with percentages in labels
                    const labels = sortedStocksEUR.map(stock => {
                        const name = stock.company_name || stock.symbol || 'Unknown';
                        const percentage = ((stock.position_value_eur / totalValueEUR) * 100).toFixed(1);
                        const shortName = name.length > 15 ? name.substring(0, 15) + '...' : name;
                        return `${shortName} (${percentage}%)`;
                    });
                    const data = sortedStocksEUR.map(stock => stock.position_value_eur);
                    const percentages = sortedStocksEUR.map(stock => ((stock.position_value_eur / totalValueEUR) * 100).toFixed(1));
                    
                    // Create the chart
                    createPieChart(ctx, labels, data, percentages, totalValueEUR, usdToEurRate);
                })
                .catch(error => {
                    console.error('Error loading stock values:', error);
                    // Fallback to show error message
                    createErrorChart(ctx, 'Unable to load current stock values');
                });
        }
        
        function createPieChart(ctx, labels, data, percentages, totalValueEUR, usdToEurRate) {
            const colors = [
                '#64b5f6', '#e91e63', '#ff9800', '#10b981', '#ef4444',
                '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
            ];
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, data.length),
                        borderColor: colors.slice(0, data.length).map(color => color + '40'),
                        borderWidth: 2,
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                color: '#8892b0',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(37, 42, 58, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#8892b0',
                            borderColor: 'rgba(100, 181, 246, 0.3)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const percentage = percentages[context.dataIndex];
                                    const value = context.parsed;
                                    return `${context.label}: €${value.toLocaleString()}`;
                                },
                                afterBody: function(context) {
                                    return [`Total Portfolio: €${totalValueEUR.toLocaleString()}`, `USD/EUR Rate: ${usdToEurRate.toFixed(4)}`];
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        function createErrorChart(ctx, message) {
            // Create a simple text display for error state
            ctx.font = '16px Inter';
            ctx.fillStyle = '#ef4444';
            ctx.textAlign = 'center';
            ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
        
        function loadStockCount() {
            // Load current stock values and count them
            fetch('./output/current_stock_values.csv?t=' + Date.now())
                .then(response => response.text())
                .then(csvText => {
                    // Parse CSV data
                    const lines = csvText.trim().split('\n');
                    const headers = lines[0].split(',');
                    
                    let totalStocks = 0;
                    let stocksWithPrices = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        const stock = {};
                        headers.forEach((header, index) => {
                            stock[header] = values[index];
                        });
                        
                        totalStocks++;
                        if (stock.source !== 'failed' && stock.position_value && parseFloat(stock.position_value) > 0) {
                            stocksWithPrices++;
                        }
                    }
                    
                    // Update the metric card
                    document.getElementById('total-stocks').textContent = totalStocks;
                    document.getElementById('stocks-info').textContent = `${stocksWithPrices} with current prices`;
                })
                .catch(error => {
                    console.error('Error loading stock count:', error);
                    document.getElementById('total-stocks').textContent = '—';
                    document.getElementById('stocks-info').textContent = 'Unable to load';
                });
        }


        function createDividendGrowthChart() {
            const ctx = document.getElementById('dividendGrowthChart').getContext('2d');
            
            // Use dividend totals by year from portfolio analysis
            const dividendsByYear = masterData.detailed_summaries?.dividends?.dividend_by_year || {};
            
            const years = Object.keys(dividendsByYear).sort();
            const values = years.map(year => dividendsByYear[year]);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Annual Dividends',
                        data: values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyDividendChart() {
            const ctx = document.getElementById('monthlyDividendChart').getContext('2d');
            
            // Group dividends by month and by company
            const monthlyData = {};
            const companies = new Set();
            
            dividendsData.forEach(d => {
                const yearMonth = d.Year_Month;
                const company = d.Company;
                
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = {};
                }
                if (!monthlyData[yearMonth][company]) {
                    monthlyData[yearMonth][company] = 0;
                }
                
                monthlyData[yearMonth][company] += d.Amount_EUR;
                companies.add(company);
            });
            
            // Filter out months with zero or negative net dividends
            const validMonths = Object.keys(monthlyData).filter(yearMonth => {
                const monthTotal = Object.values(monthlyData[yearMonth]).reduce((sum, amount) => sum + amount, 0);
                return monthTotal > 0;
            }).sort();
            
            // Get top companies by total dividends for better visualization
            const companyTotals = {};
            Array.from(companies).forEach(company => {
                companyTotals[company] = 0;
                validMonths.forEach(yearMonth => {
                    if (monthlyData[yearMonth][company]) {
                        companyTotals[company] += monthlyData[yearMonth][company];
                    }
                });
            });
            
            const topCompanies = Object.entries(companyTotals)
                .filter(([_, total]) => total > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)  // Show top 10 companies
                .map(([company, _]) => company);
            
            // Create datasets for each company
            const colors = [
                '#64b5f6', '#e91e63', '#ff9800', '#10b981', '#ef4444',
                '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
            ];
            
            const datasets = topCompanies.map((company, index) => ({
                label: company.length > 20 ? company.substring(0, 20) + '...' : company,
                data: validMonths.map(yearMonth => {
                    const amount = monthlyData[yearMonth][company] || 0;
                    return amount > 0 ? amount : 0; // Only show positive contributions
                }),
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                borderWidth: 1
            }));
            
            // Format month labels
            const labels = validMonths.map(yearMonth => {
                const [year, month] = yearMonth.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }


        function createTopDividendStocksChart() {
            const ctx = document.getElementById('topDividendStocksChart').getContext('2d');
            
            // Calculate total dividends by company from all transactions
            const dividendsByCompany = {};
            dividendsData.forEach(d => {
                if (!dividendsByCompany[d.Company]) {
                    dividendsByCompany[d.Company] = 0;
                }
                dividendsByCompany[d.Company] += d.Amount_EUR;
            });
            
            // Get top 8 dividend companies
            const stocks = Object.entries(dividendsByCompany)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            const labels = stocks.map(([name]) => name.length > 15 ? name.substring(0, 15) + '...' : name);
            const data = stocks.map(([_, value]) => value);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net Dividends',
                        data: data,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${formatCurrency(context.parsed.x)}`;
                                }
                            }
                        }
                    }
                }
            });
        }


        function createCumulativePerformanceChart() {
            const ctx = document.getElementById('cumulativePerformanceChart').getContext('2d');
            
            // Create cumulative data
            const allTransactions = [];
            
            // Add buy transactions
            buysData.filter(d => d.Is_Valid_Buy).forEach(t => {
                allTransactions.push({
                    date: t.Date,
                    type: 'buy',
                    amount: Math.abs(t.Amount_EUR)
                });
            });
            
            // Add sell transactions
            sellsData.filter(d => d.Is_Valid_Sell).forEach(t => {
                allTransactions.push({
                    date: t.Date,
                    type: 'sell',
                    amount: t.Amount_EUR
                });
            });
            
            // Add dividend transactions (verified positive dividends only)
            dividendsData.filter(d => d.Status === 'verified' && d.Amount_EUR > 0).forEach(t => {
                allTransactions.push({
                    date: t.Date,
                    type: 'dividend',
                    amount: t.Amount_EUR
                });
            });
            
            // Sort by date
            allTransactions.sort((a, b) => a.date - b.date);
            
            // Calculate cumulative values
            let cumulativeInvested = 0;
            let cumulativeReturns = 0;
            const cumulativeData = [];
            
            allTransactions.forEach(transaction => {
                if (transaction.type === 'buy') {
                    cumulativeInvested += transaction.amount;
                } else if (transaction.type === 'sell') {
                    cumulativeReturns += transaction.amount;
                } else if (transaction.type === 'dividend') {
                    cumulativeReturns += transaction.amount;
                }
                
                cumulativeData.push({
                    date: transaction.date,
                    invested: cumulativeInvested,
                    returns: cumulativeReturns,
                    netValue: cumulativeInvested - cumulativeReturns
                });
            });
            
            // Sample data for chart (take every nth point for performance)
            const sampledData = cumulativeData.filter((_, index) => index % Math.max(1, Math.floor(cumulativeData.length / 50)) === 0);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledData.map(d => d.date.toLocaleDateString()),
                    datasets: [{
                        label: 'Cumulative Invested',
                        data: sampledData.map(d => d.invested),
                        borderColor: '#64b5f6',
                        backgroundColor: 'rgba(100, 181, 246, 0.1)',
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Cumulative Returns',
                        data: sampledData.map(d => d.returns),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Net Investment',
                        data: sampledData.map(d => d.netValue),
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Product Analysis Functions
        function initializeProductAnalysis() {
            populateProductDropdown();
            populateYearDropdown();
            setupFilterHandlers();
        }

        function populateProductDropdown() {
            const productSelect = document.getElementById('productSelect');
            
            // Get unique products from dividend data that have net positive dividends
            const products = new Set();
            const productNetDividends = {};
            
            // Calculate net dividends per product (include ALL transactions to match bar chart)
            dividendsData.forEach(d => {
                if (!productNetDividends[d.Company]) {
                    productNetDividends[d.Company] = 0;
                }
                productNetDividends[d.Company] += d.Amount_EUR;
            });
            
            // Add products with positive net dividends
            Object.keys(productNetDividends).forEach(company => {
                if (productNetDividends[company] > 0) {
                    products.add(company);
                }
            });
            
            // Sort products alphabetically
            const sortedProducts = Array.from(products).sort();
            
            // Clear existing options (except the default one)
            productSelect.innerHTML = '<option value="">-- All Products --</option>';
            
            // Add product options
            sortedProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productSelect.appendChild(option);
            });
        }

        function populateYearDropdown() {
            const yearSelect = document.getElementById('yearSelect');
            
            // Get unique years from dividend data (include ALL transactions to match bar chart)
            const years = new Set();
            const yearNetDividends = {};
            
            // Calculate net dividends per year
            dividendsData.forEach(d => {
                const year = d.Date.getFullYear();
                if (!yearNetDividends[year]) {
                    yearNetDividends[year] = 0;
                }
                yearNetDividends[year] += d.Amount_EUR;
            });
            
            // Only include years with positive net dividends
            Object.keys(yearNetDividends).forEach(year => {
                if (yearNetDividends[year] > 0) {
                    years.add(parseInt(year));
                }
            });
            
            // Sort years in descending order (newest first)
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            // Clear existing options (except the default one)
            yearSelect.innerHTML = '<option value="">-- All Years --</option>';
            
            // Add year options
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            });
        }

        function setupFilterHandlers() {
            const productSelect = document.getElementById('productSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            // Handle product selection changes
            productSelect.addEventListener('change', function() {
                updateFilters();
            });
            
            // Handle year selection changes
            yearSelect.addEventListener('change', function() {
                updateFilters();
            });
        }

        function updateFilters() {
            const selectedProduct = document.getElementById('productSelect').value;
            const selectedYear = document.getElementById('yearSelect').value;
            
            // Update available options based on current selections
            updateAvailableOptions(selectedProduct, selectedYear);
            
            // Show dividend table if any filter is selected
            if (selectedProduct || selectedYear) {
                showDividendTable(selectedProduct, selectedYear);
            } else {
                hideDividendTable();
            }
        }

        function updateAvailableOptions(selectedProduct, selectedYear) {
            // Update product dropdown based on selected year
            if (selectedYear) {
                updateProductOptions(selectedYear, selectedProduct);
            } else {
                populateProductDropdown();
                // Restore product selection if it was set
                if (selectedProduct) {
                    document.getElementById('productSelect').value = selectedProduct;
                }
            }
            
            // Update year dropdown based on selected product
            if (selectedProduct) {
                updateYearOptions(selectedProduct, selectedYear);
            } else {
                populateYearDropdown();
                // Restore year selection if it was set
                if (selectedYear) {
                    document.getElementById('yearSelect').value = selectedYear;
                }
            }
        }

        function updateProductOptions(selectedYear, currentProduct) {
            const productSelect = document.getElementById('productSelect');
            
            // Get products that have dividends in the selected year
            const productsInYear = new Set();
            const productNetDividends = {};
            
            dividendsData
                .filter(d => d.Date.getFullYear().toString() === selectedYear)
                .forEach(d => {
                    if (!productNetDividends[d.Company]) {
                        productNetDividends[d.Company] = 0;
                    }
                    productNetDividends[d.Company] += d.Amount_EUR;
                });
            
            // Add products with positive net dividends in that year
            Object.keys(productNetDividends).forEach(company => {
                if (productNetDividends[company] > 0) {
                    productsInYear.add(company);
                }
            });
            
            // Sort products alphabetically
            const sortedProducts = Array.from(productsInYear).sort();
            
            // Update dropdown
            productSelect.innerHTML = '<option value="">-- All Products --</option>';
            sortedProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productSelect.appendChild(option);
            });
            
            // Restore selection if it's still valid
            if (currentProduct && productsInYear.has(currentProduct)) {
                productSelect.value = currentProduct;
            }
        }

        function updateYearOptions(selectedProduct, currentYear) {
            const yearSelect = document.getElementById('yearSelect');
            
            // Get years that have dividends for the selected product
            const yearsForProduct = new Set();
            const yearNetDividends = {};
            
            dividendsData
                .filter(d => d.Company === selectedProduct)
                .forEach(d => {
                    const year = d.Date.getFullYear();
                    if (!yearNetDividends[year]) {
                        yearNetDividends[year] = 0;
                    }
                    yearNetDividends[year] += d.Amount_EUR;
                });
            
            // Add years with positive net dividends for that product
            Object.keys(yearNetDividends).forEach(year => {
                if (yearNetDividends[year] > 0) {
                    yearsForProduct.add(parseInt(year));
                }
            });
            
            // Sort years in descending order
            const sortedYears = Array.from(yearsForProduct).sort((a, b) => b - a);
            
            // Update dropdown
            yearSelect.innerHTML = '<option value="">-- All Years --</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            });
            
            // Restore selection if it's still valid
            if (currentYear && yearsForProduct.has(parseInt(currentYear))) {
                yearSelect.value = currentYear;
            }
        }

        function showDividendTable(productName, selectedYear) {
            // First, get ALL dividend transactions for status calculation
            let allDividends = dividendsData.filter(d => true);
            
            // Apply product filter if specified
            if (productName) {
                allDividends = allDividends.filter(d => d.Company === productName);
            }
            
            // Apply year filter if specified  
            if (selectedYear) {
                allDividends = allDividends.filter(d => d.Date.getFullYear().toString() === selectedYear);
            }

            // Group by year-month and calculate status from ALL transactions
            const dividendsByMonth = {};
            // Use corrected yearly values from JSON instead of raw CSV calculations
            // Get corrected yearly breakdown from portfolio data
            const correctedYearlyDividends = masterData.portfolio_summary?.dividends?.yearly_breakdown || masterData.detailed_summaries?.dividends?.dividend_by_year || {};
            
            allDividends.forEach(d => {
                const yearMonth = d.Year_Month;
                const year = d.Date.getFullYear().toString();
                
                if (!dividendsByMonth[yearMonth]) {
                    dividendsByMonth[yearMonth] = {
                        amount: 0,
                        transactions: 0,
                        positiveTransactions: 0,
                        negativeTransactions: 0,
                        transactionDetails: [],
                        statuses: []  // Track individual transaction statuses
                    };
                }
                
                // Add ALL transactions to match bar chart calculation (don't filter by status)
                dividendsByMonth[yearMonth].amount += d.Amount_EUR;
                // Always count ALL transactions for status calculation
                dividendsByMonth[yearMonth].transactions += 1;
                dividendsByMonth[yearMonth].transactionDetails.push({
                    amount: d.Amount_EUR,
                    description: d.Description
                });
                dividendsByMonth[yearMonth].statuses.push(d.Status);  // Track individual status
                
                if (d.Amount_EUR > 0) {
                    dividendsByMonth[yearMonth].positiveTransactions += 1;
                } else if (d.Amount_EUR < 0) {
                    dividendsByMonth[yearMonth].negativeTransactions += 1;
                }
            });

            // No yearly corrections applied to match bar chart calculation

            // Filter out months with zero or negative net dividends and sort by year-month
            const sortedMonths = Object.keys(dividendsByMonth)
                .filter(yearMonth => dividendsByMonth[yearMonth].amount > 0)
                .sort();

            // Update UI
            let filterDescription = '';
            if (productName && selectedYear) {
                filterDescription = `${productName} (${selectedYear})`;
            } else if (productName) {
                filterDescription = productName;
            } else if (selectedYear) {
                filterDescription = `All Products (${selectedYear})`;
            } else {
                filterDescription = 'All Products';
            }
            
            document.getElementById('selectedProductName').textContent = filterDescription;
            document.getElementById('dividendTableContainer').style.display = 'block';

            // Populate table
            const tableBody = document.getElementById('dividendTableBody');
            tableBody.innerHTML = '';

            let totalDividends = 0;
            let totalTransactions = 0;

            sortedMonths.forEach(yearMonth => {
                const data = dividendsByMonth[yearMonth];
                totalDividends += data.amount;
                totalTransactions += data.transactions;

                // Determine the correct status for this month
                const monthStatus = determineMonthStatus(data);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${formatYearMonth(yearMonth)}</td>
                    <td style="text-align: right;" class="dividend-amount">€${data.amount.toFixed(2)}</td>
                    <td style="text-align: center;">
                        <span class="dividend-status status-${monthStatus.replace('_', '-')}">${formatStatus(monthStatus)}</span>
                    </td>
                    <td style="text-align: center;" class="transaction-count">${data.transactions}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update summary
            const averagePerMonth = sortedMonths.length > 0 ? totalDividends / sortedMonths.length : 0;
            document.getElementById('totalDividends').textContent = `€${totalDividends.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('activeMonths').textContent = sortedMonths.length;
            document.getElementById('averagePerMonth').textContent = `€${averagePerMonth.toFixed(2)}`;
        }

        function hideDividendTable() {
            document.getElementById('dividendTableContainer').style.display = 'none';
        }

        function formatYearMonth(yearMonth) {
            const [year, month] = yearMonth.split('-');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function determineMonthStatus(monthData) {
            const { statuses, transactions, positiveTransactions, negativeTransactions } = monthData;
            
            // If we have status data from CSV, use it intelligently
            if (statuses && statuses.length > 0) {
                const uniqueStatuses = [...new Set(statuses)];
                
                // If all transactions are verified, determine by transaction pattern
                if (uniqueStatuses.length === 1 && uniqueStatuses[0] === 'verified') {
                    // Single positive transaction, no negative = No withholding
                    if (transactions === 1 && positiveTransactions === 1 && negativeTransactions === 0) {
                        return 'no_withholding';
                    }
                    // One positive + one negative = Standard verified dividend with tax
                    else if (transactions === 2 && positiveTransactions === 1 && negativeTransactions === 1) {
                        return 'verified';  
                    }
                    // Multiple positive transactions (different companies/payments) in same month
                    else if (positiveTransactions > 1) {
                        return 'multiple_payments';
                    }
                    // Other verified patterns
                    else {
                        return 'verified';
                    }
                }
                // If all transactions are unverified
                else if (uniqueStatuses.length === 1 && uniqueStatuses[0] === 'unverified') {
                    return 'complex';
                }
                // Mixed verified and unverified status
                else {
                    return 'complex';
                }
            }
            
            // Fallback to original logic if no status data
            // Exactly 1 positive transaction, no negative = No withholding
            if (transactions === 1 && positiveTransactions === 1 && negativeTransactions === 0) {
                return 'no_withholding';
            }
            // Exactly 2 transactions: 1 positive + 1 negative = Verified (proper dividend + tax)
            else if (transactions === 2 && positiveTransactions === 1 && negativeTransactions === 1) {
                return 'verified';
            }
            // Multiple dividend payments in same month = Multiple payments
            else if (positiveTransactions > 1) {
                return 'multiple_payments';
            }
            // Other cases = Complex
            else {
                return 'complex';
            }
        }

        function formatStatus(status) {
            switch(status) {
                case 'verified': return 'Verified';
                case 'no_withholding': return 'No Withholding';
                case 'multiple_payments': return 'Multiple Payments';
                case 'complex': return 'Complex';
                default: return status;
            }
        }

        // Stock Analysis Functions (Using SQLite Cache)
        let stockAnalysisChart = null;
        const STOCK_API_BASE = 'http://localhost:8001';

        let currentStock = null;
        let currentTimeRange = 'YTD';

        function initializeStockAnalysis() {
            console.log('Initializing stock analysis with cached data...');
            loadAvailableStocks();
            
            // Add event listener for stock selection
            document.getElementById('stockSelector').addEventListener('change', function(e) {
                const selectedSymbol = e.target.value;
                currentStock = selectedSymbol;
                
                // Always clear first
                clearStockChart();
                
                if (selectedSymbol) {
                    // Show time range buttons
                    document.getElementById('timeRangeButtons').style.display = 'flex';
                    
                    // Small delay to ensure cleanup is complete
                    setTimeout(() => {
                        loadStockAnalysis(selectedSymbol, currentTimeRange);
                    }, 100);
                } else {
                    // Hide time range buttons
                    document.getElementById('timeRangeButtons').style.display = 'none';
                }
            });
            
            // Add event listeners for time range buttons
            document.querySelectorAll('.time-range-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (!currentStock) return;
                    
                    // Update active button
                    document.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update current time range and reload chart
                    currentTimeRange = this.dataset.range;
                    loadStockAnalysis(currentStock, currentTimeRange);
                });
            });
        }

        function loadAvailableStocks() {
            fetch(`${STOCK_API_BASE}/available-stocks`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(stocks => {
                    console.log('Available stocks loaded from cache:', stocks.length);
                    populateStockDropdown(stocks);
                })
                .catch(error => {
                    console.error('Error loading available stocks:', error);
                    showStockError('Unable to load available stocks. Make sure the stock API server is running on port 8001.');
                });
        }

        function populateStockDropdown(stocks) {
            const selector = document.getElementById('stockSelector');
            
            // Clear existing options except the first one
            while (selector.children.length > 1) {
                selector.removeChild(selector.lastChild);
            }
            
            // Add stock options
            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.symbol;
                option.textContent = `${stock.symbol} - ${stock.company_name}`;
                selector.appendChild(option);
            });
            
            console.log(`Populated dropdown with ${stocks.length} stocks`);
        }

        function loadStockAnalysis(symbol, timeRange = '5Y') {
            console.log(`Loading cached analysis for ${symbol} (${timeRange})`);
            
            // Show loading indicator
            document.getElementById('stockAnalysisLoading').style.display = 'block';
            
            fetch(`${STOCK_API_BASE}/stock-analysis/${symbol}?range_type=${timeRange}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Stock analysis data loaded from cache (${timeRange}):`, data);
                    console.log('Price data points:', data.price_data?.length);
                    console.log('Transactions:', data.transactions?.length);
                    console.log('Date range:', data.data_range);
                    createStockAnalysisChart(data, timeRange);
                })
                .catch(error => {
                    console.error(`Error loading analysis for ${symbol}:`, error);
                    showStockError(`Unable to load cached data for ${symbol} (${timeRange}). ${error.message}`);
                })
                .finally(() => {
                    // Hide loading indicator
                    document.getElementById('stockAnalysisLoading').style.display = 'none';
                });
        }

        function createStockAnalysisChart(data, timeRange = '5Y') {
            console.log('Creating chart for:', data.symbol, 'with range:', timeRange);
            
            const canvas = document.getElementById('stockAnalysisChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Properly destroy existing chart
            if (stockAnalysisChart) {
                console.log('Destroying existing chart');
                stockAnalysisChart.destroy();
                stockAnalysisChart = null;
            }
            
            // Clear the canvas completely
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Validate data
            if (!data.price_data || !Array.isArray(data.price_data) || data.price_data.length === 0) {
                console.error('Invalid or empty price data:', data.price_data);
                showStockError('No price data available for this stock.');
                return;
            }
            
            console.log('Processing', data.price_data.length, 'price points for', data.symbol);
            
            // Prepare price data for Chart.js (with proper dates)
            const priceData = data.price_data.map((point, index) => {
                if (point.price === null || point.price === undefined) {
                    console.warn('Invalid price point at index', index, ':', point);
                    return null;
                }
                return {
                    x: new Date(point.date), // Convert to Date object
                    y: point.price
                };
            }).filter(point => point !== null);
            
            console.log('Valid price data points:', priceData.length);
            
            // Prepare transaction data
            const buyTransactions = [];
            const sellTransactions = [];
            
            console.log('Processing', data.transactions?.length || 0, 'transactions');
            
            if (data.transactions && data.transactions.length > 0) {
                data.transactions.forEach((transaction, index) => {
                    // Find the closest price point for this transaction date
                    const closestPricePoint = data.price_data.find(point => point.date === transaction.date);
                    if (closestPricePoint) {
                        const transactionPoint = {
                            x: new Date(transaction.date), // Convert to Date object
                            y: closestPricePoint.price,
                            transaction: transaction
                        };
                        
                        if (transaction.type === 'buy') {
                            buyTransactions.push(transactionPoint);
                        } else {
                            sellTransactions.push(transactionPoint);
                        }
                    } else {
                        console.warn('No price data found for transaction date:', transaction.date);
                    }
                });
                
                console.log('Buy transactions:', buyTransactions.length);
                console.log('Sell transactions:', sellTransactions.length);
            }
            
            // Create datasets with price line and transaction markers
            const datasets = [{
                label: `${data.symbol} Price`,
                data: priceData,
                borderColor: '#64b5f6',
                backgroundColor: 'rgba(100, 181, 246, 0.1)',
                fill: true,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 4
            }];
            
            // Add buy transaction markers
            if (buyTransactions.length > 0) {
                datasets.push({
                    label: 'Buy Orders',
                    data: buyTransactions,
                    backgroundColor: '#10b981',
                    borderColor: '#10b981',
                    pointStyle: 'triangle',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    showLine: false,
                    order: 1
                });
            }
            
            // Add sell transaction markers
            if (sellTransactions.length > 0) {
                datasets.push({
                    label: 'Sell Orders',
                    data: sellTransactions,
                    backgroundColor: '#ef4444',
                    borderColor: '#ef4444',
                    pointStyle: 'triangleDown',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    showLine: false,
                    order: 1
                });
            }
            
            console.log('Dataset created with', priceData.length, 'price points,', buyTransactions.length, 'buys,', sellTransactions.length, 'sells');
            
            console.log('Creating Chart.js instance with', datasets.length, 'datasets');
            
            try {
                stockAnalysisChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.symbol} - ${timeRange} Price History with Transactions`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleDateString();
                                },
                                label: function(context) {
                                    if (context.dataset.label.includes('Orders')) {
                                        const transaction = context.raw.transaction;
                                        return [
                                            `${transaction.type.toUpperCase()}: ${transaction.shares} shares`,
                                            `Price: $${context.parsed.y.toFixed(2)}`,
                                            `Amount: €${transaction.amount_eur.toFixed(2)}`
                                        ];
                                    } else {
                                        return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            } catch (error) {
                console.error('Error creating stock analysis chart:', error);
                showStockError('Error creating chart. Please try selecting another stock.');
            }
        }

        function clearStockChart() {
            if (stockAnalysisChart) {
                stockAnalysisChart.destroy();
                stockAnalysisChart = null;
            }
            
            // Also clear the canvas
            const canvas = document.getElementById('stockAnalysisChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function showStockError(message) {
            const ctx = document.getElementById('stockAnalysisChart').getContext('2d');
            
            // Clear existing chart
            clearStockChart();
            
            // Show error message
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Inter';
            ctx.fillStyle = '#ef4444';
            ctx.textAlign = 'center';
            ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>